name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned, labeled]
  pull_request:
    types: [opened, synchronize]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude') || contains(github.event.label.name, 'claude'))) ||
      (github.event_name == 'pull_request' && (contains(github.event.pull_request.body, '@claude') || contains(github.event.pull_request.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          label_trigger: "claude"
          base_branch: "main"
          branch_prefix: "claude/"

          additional_permissions: |
            actions: read

          settings: |
            {
              "env": {
                "GH_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
              },
              "allowedCommands": [
                "Bash(git checkout:*)",
                "Bash(git add:*)",
                "Bash(git commit:*)",
                "Bash(git push:*)",
                "Bash(git branch:*)",
                "Bash(gh pr create:*)",
                "Bash(gh pr view:*)",
                "Bash(gh issue comment:*)",
                "Bash(gh issue view:*)",
                "Bash(gh issue edit:*)"
              ]
            }

          prompt: |
            REPO: ${{ github.repository }}
            ISSUE/PR: ${{ github.event.issue.number || github.event.pull_request.number }}

            Context:
            ${{ github.event.issue.title && format('Issue Title: {0}', github.event.issue.title) || '' }}
            ${{ github.event.issue.body && format('Issue Description: {0}', github.event.issue.body) || '' }}
            ${{ github.event.pull_request.title && format('PR Title: {0}', github.event.pull_request.title) || '' }}
            ${{ github.event.pull_request.body && format('PR Description: {0}', github.event.pull_request.body) || '' }}
            ${{ github.event.comment.body && format('Comment: {0}', github.event.comment.body) || '' }}
            ${{ github.event.review.body && format('Review: {0}', github.event.review.body) || '' }}

            ## Repository Context

            This is neat-little-package, a collection of Claude Code plugins including:
            - **box-factory**: Toolkit for creating Claude Code components (plugins, commands, skills, hooks)
            - **dmv**: Git and GitHub workflow preferences
            - **mr-sparkle**: Linting and autoformatting

            Before starting any task:
            1. Read @CLAUDE.md for repository-wide guidelines
            2. For Box Factory work, read @plugins/box-factory/CLAUDE.md for component patterns and philosophy

            ## Box Factory Philosophy (if working on box-factory plugin)

            - **Low-Maintenance First**: Skills defer to official docs via WebFetch, never hardcode model names/tool lists/syntax
            - **Two-Layer Approach**: Layer 1 = Official specs, Layer 2 = Best practices/interpretive guidance
            - **Knowledge Delta Filter**: Only document what Claude doesn't already know
            - **Evidence-Based**: Claims grounded in official docs OR clearly marked as opinions

            ## General Guidelines

            - Use TodoWrite to track complex multi-step tasks
            - If the request is just a question, answer it without creating a PR
            - Be concise and efficient

            ## For Code Changes

            1. Run appropriate tests/linting after making changes
            2. If tests fail, debug and fix before completing
            3. Check for type errors or compilation issues

            ## When Working on Issues

            1. Create a new branch for your changes
            2. Make the necessary code changes
            3. Commit with a descriptive message (terse, single-line, no emojis)
            4. Create a pull request with:
               - Clear title summarizing changes
               - Description explaining what and why
               - Include "Fixes #${{ github.event.issue.number || github.event.pull_request.number }}" to link to issue
            5. After creating PR:
               - Comment on issue with PR link and brief summary
            6. DO NOT merge - leave open for review
            7. If you cannot create a PR:
               - Comment explaining what you accomplished
               - Include commit SHA if changes were committed

            ## When Working on PRs

            - PR review comments are PRIMARY source of truth
            - NEVER revert previously approved changes
            - Read ALL previous review comments before making changes
            - If reviewing: Provide specific feedback, suggest improvements, ensure test coverage
            - If responding to reviews: Address feedback or explain your approach

          claude_args: >-
            --allowed-tools "
            Bash(git:*),
            Bash(gh:*),
            Bash(command -v:*),
            Bash(./*),
            Read(**),
            Edit(**),
            MultiEdit(**),
            Glob(**),
            Grep(**),
            Write(**),
            TodoWrite,
            Task,
            WebFetch,
            WebSearch
            "
            --model sonnet
